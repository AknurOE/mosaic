<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | MOSAIC</title>
    <link rel="stylesheet" href="auth.css"> </head>
<body>
    <div class="auth-container">
        <form id="profileForm" class="auth-form">
            <h1>Settings</h1>
            <p>Update your account information</p>
            
            <div id="message" class="error-box" style="display: none; background: #d4edda; color: #155724; border-color: #c3e6cb;"></div>
            <div id="error" class="error-box" style="display: none;"></div>

            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="New username">
            </div>

            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="email" placeholder="New email">
            </div>

            <div class="input-group">
                <label>New Password (leave blank to keep current)</label>
                <input type="password" id="password" placeholder="Min. 6 characters">
            </div>
            
            <button type="submit" class="auth-btn">Save Changes</button>
            
            <div class="auth-footer">
                <a href="index.html">‚Üê Back to Feed</a>
            </div>
        </form>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        async function loadProfile() {
            try {
                const res = await fetch('/api/users/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('username').value = data.username;
                    document.getElementById('email').value = data.email;
                }
            } catch (err) {
                console.error("Failed to load profile");
            }
        }

        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const errorBox = document.getElementById('error');
            const msgBox = document.getElementById('message');
            
            errorBox.style.display = 'none';
            msgBox.style.display = 'none';

            const payload = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value
            };

            const newPass = document.getElementById('password').value;
            if (newPass) payload.password = newPass;

            try {
                const res = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    msgBox.innerText = "Profile updated successfully!";
                    msgBox.style.display = 'block';
                    if (newPass) {
                        msgBox.innerText += " Please log in again with your new password.";
                        setTimeout(() => {
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                } else {
                    errorBox.innerText = data.message || "Update failed";
                    errorBox.style.display = 'block';
                }
            } catch (err) {
                errorBox.innerText = "Server error";
                errorBox.style.display = 'block';
            }
        };

        loadProfile();
    </script>
</body>
</html>